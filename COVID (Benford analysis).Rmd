```{r}
pacman::p_load(tidyverse, here, benford.analysis, htmltab)
```

# COVID data integrity by country

## COVID: Our World in Data

```{r}
covid <- 
  read_csv("https://github.com/owid/covid-19-data/blob/master/public/data/owid-covid-data.csv?raw=true") %>% 
  select(iso_code, continent, location, date, 
         new_cases, new_deaths, new_tests, new_vaccinations,
         population, extreme_poverty, human_development_index)
```

## Benford analysis

Reference: <https://hill.math.gatech.edu/publications/PAPER%20PDFS/TheFirstDigitPhenomenonAmericanScientist1996.pdf>

### Benford: Example

```{r}
covid %>% filter(new_cases < 0) %>% count()
```

```{r}
benford <- benford(covid %>% pull(new_cases) %>% na.omit(), 1, "both")
plot(benford)
```

```{r}
benford <- benford(covid %>% 
                     filter(iso_code == "USA") %>%
                     pull(new_cases) %>% na.omit(), 1, sign = "both")

madiff <- 
  suspectsTable(benford) %>% 
  as_tibble() %>% 
  select("absolute.diff") %>% 
  summarise(mean = mean(absolute.diff)) %>% 
  pull()

madiff
```

### Vectorized Benford analysis

```{r}
filter_data <- 
  function(data, iso_code, my_list){
    iso_code <- enquo(iso_code)
    filtered <- 
      data %>% 
      filter(UQ(iso_code) %in% my_list) %>% 
      pull(new_cases) %>% 
      na.omit()
}

madiff <- 
  function(filtered) {
    mean <- 
      suspectsTable(filtered) %>% 
      select("absolute.diff") %>% 
      summarise(mean = (mean(absolute.diff))) %>% 
      pull(mean)
  }
```

```{r}
countries <- c("GTM", "USA", "CHN")
```

```{r}
vectorize <- function(countries) {
  binded <- data.frame()
  for (country in countries) {
    filtered <- filter_data(covid, iso_code, my_list = country)
    benford <- benford(filtered, 1, sign = "both")
    value <- madiff(benford)
    print(value)
  }
  binded %>% as_tibble()
}
```

```{r}
lista <- list()
for (i in countries) {
  filtered <- filter_data(covid, iso_code, my_list = i)
  benford <- benford(filtered, 1, sign = "both")
  value <- madiff(benford)
  lista[[i]] <- value
}
```

```{r}
as_tibble(lista)
```

## Democracy Index: The Economist Intelligence Unit

```{r}
democracy <- 
  htmltab("https://en.wikipedia.org/wiki/Democracy_Index", 6) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  # rename_with(~str_remove(., "x")) %>% 
  select(country, region, "regime" = regime_type, 
         everything(), -c(x2020_rank))
```
